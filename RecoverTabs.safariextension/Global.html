<!DOCTYPE HTML>
<html>
<head>

<script type='text/javascript'>
// TODO:
// Store title data, create toolbar button
// Can toolbar button be optional?

// Place to store URLs of closed tabs
var closedTabs = [];
// Gets setting values from extension preferences in Safari's Preferences (created in Extension Builder)
var tabOpenStyle = safari.extension.settings.tabOpenStyle;
var maxClosedTabs = safari.extension.settings.maxClosedTabs;
var savePrivateBrowsingTabs = safari.extension.settings.savePrivateBrowsingTabs;

// Event listens to close-tab signals from Safari and saves URL of target tab
safari.application.addEventListener("close", function (e) {
    toSaveURL = e.target.url;


    // Make sure target is a tab
    if (!(e.target instanceof SafariBrowserTab))
        return;

    //Make sure closedTabs doesn't already have a duplicate
    // var tab = findTabByUrl(toSaveURL);
    // if (tab && tab.window === e.target.browserWindow)
    //     return;

    //Check if the URL is "" (seems to happen when you close a not-fully-loaded page) or undefined (no URL)
    if (toSaveURL === "" && toSaveURL === undefined)
        return;

    //Don't save private browsing tabs if so configured
    if (safari.application.privateBrowsing.enabled && (savePrivateBrowsingTabs === false))
        return;

    closedTabs.push({window: e.target.browserWindow, url: toSaveURL});

    // Purges earliest tabs if saved number of tabs goes over maxClosedTabs (to prevent memory leaks in extended browsing sessions), if user has a limit defined
    if (maxClosedTabs != -1) {
        if (closedTabs.length > maxClosedTabs)
            closedTabs.shift();
    }
}, true);

// This does all the heavy-work of reopening
function reopenClosedTabs() {
    var currentWindow;

    if (closedTabs.length === 0)
        return;

    // This reopens tabs, clearing out saved URLs as they are reopened
    var reopenTab = closedTabs.pop();
    var windowIndex = safari.application.browserWindows.indexOf(reopenTab.window);

    if (windowIndex === -1) {
        //No window that matches, so open a new window
        //TODO: Can you pass in a URL here? If not, handle this so we don't create an empty tab
        currentWindow = safari.application.openBrowserWindow(reopenTab.url);
    } else {
        //Reopen in an existing window
        currentWindow = reopenTab.window;
    }

    var openPosition = currentWindow.tabs.indexOf(currentWindow.activeTab);
    // New tab is placed after activeTab
    var newTab = currentWindow.openTab(tabOpenStyle, openPosition + 1);
    newTab.url = reopenTab.url;
}

// Message gets caught, reopenClosedTabs() gets called
function handleKeyboardMessage(e) {
    if (e.name == 'reopenTab')
        reopenClosedTabs();
}

// Gets called when Safari sends a 'change' message
function updateSettings(e) {
    if (e.key == 'tabOpenStyle')
        tabOpenStyle = e.newValue;

    if (e.key == 'maxClosedTabs') {
        maxClosedTabs = e.newValue;

        // If new setting is anything other than infinite...
        if (maxClosedTabs != -1) {
            // ...remove excess URLs to match new max number of saved URLs
            while (closedTabs.length > maxClosedTabs) {
                closedTabs.shift();
            }
        }
    }
}

function findTabByUrl(url) {
    var matchingTab;
    closedTabs.forEach(function(tab) {
        if (tab.url === url) {
            matchingTab = tab;
        }
    });

    return matchingTab;
}

 
// Listeners for signals from outside this file  -------------------------------------

// Listens to message from injected keyboardShortcutHandler.js
safari.application.addEventListener('message', handleKeyboardMessage, false);
// Listens to changes in settings
safari.extension.settings.addEventListener('change', updateSettings, false);

</script>

</head>
</html>
